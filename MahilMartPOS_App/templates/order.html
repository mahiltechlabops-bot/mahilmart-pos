{% extends 'base.html' %}

{% block content %}
<!DOCTYPE html>
<html>
<head>
    <title>Order Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f6f9;
            margin: 0;
        }

        .container {
            max-width: 1500px;
            margin: auto;
        }

        .card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h2 {
            margin: 0;
            font-size: 22px;
            color: #333;
        }

        .header button {
            background-color: #007bff;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .filters input,
        .filters select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            flex: 1;
        }

        .filters button {
            background-color: #6c757d;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f9f9f9;
            color: #333;
        }

        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            text-transform: capitalize;
        }

        .status.completed { background-color: #d4edda; color: #155724; }
        .status.pending { background-color: #fff3cd; color: #856404; }
        .status.cancelled { background-color: #f8d7da; color: #721c24; }

        .pagination {
            margin-top: 20px;
            text-align: right;
        }

        .pagination a {
            display: inline-block;
            padding: 8px 12px;
            margin: 0 2px;
            background-color: #eee;
            color: #333;
            border-radius: 4px;
            text-decoration: none;
        }

        .pagination a.active {
            background-color: #007bff;
            color: white;
        }
        
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="header">
            <div id="paymentModal" style="display:none; position:fixed; top:20%; left:35%; background:white; border:1px solid #ccc; padding:20px; z-index:9999;">
                <h3>Update Payment</h3>
                <form method="post" action="" id="paymentForm">
                    {% csrf_token %}
                    <input type="hidden" name="order_id" id="popup_order_id">
                    
                    <label>Total Amount:</label>
                    <input type="text" id="popup_total" readonly><br><br>
                    
                    <label>Advance Paid:</label>
                    <input type="number" name="advance" id="popup_advance" readonly><br><br>
                    
                    <label>Paid Amount:</label>
                    <input type="number" name="paid_now" id="popup_paid_now"><br><br>
      
                    <label>Due Balance:</label>
                    <input type="number" name="due_balance" id="popup_due" readonly><br><br>
                    
                    <button type="submit">Save</button>
                    <button type="button" onclick="closeModal()">Cancel</button>
                </form>
            </div>
            
            <h2>Order Management</h2>
            <a href="{% url 'create_order' %}">
                <button>+ New Order</button>
            </a>
        </div>

        <form method="get" class="filters">
            <input type="text" name="q" placeholder="Search orders..." value="{{ request.GET.q }}">
            <select name="status">
                <option value="">All Status</option>
                <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
                <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed</option>
                <option value="cancelled" {% if request.GET.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
            </select>

            <input type="date" name="date" value="{{ request.GET.date }}">
            <button type="submit">Filter</button>
        </form>

        <table>
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Date</th>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Advance Paid</th>
                    <th>Paid Amount</th>
                    <th>Due Balance</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    <td>{{ order.order_id }}</td>
                    <td>{{ order.customer_name }}</td>
                    <td>{{ order.date_of_order|date:"d-m-Y H:i" }}</td>
                    <td>{{ order.items.count }}</td>
                    <td>₹{{ order.total_order_amount }}</td>
                    <td>₹{{ order.advance }}</td>
                    <td>₹{{ order.paid_amount }}</td>
                    <td>₹{{ order.due_balance }}</td>
                    <td><span class="status {{ order.order_status }}">{{ order.order_status }}</span></td>
                    <td>
                        <a href="{% url 'order_detail' order.order_id %}">View</a>
                        {% if order.order_status == 'pending' %}
                        <span style="margin-left: 15px;">
                            <a href="javascript:void(0);"
                            class="mark-paid-link"
                            data-order-id="{{ order.order_id }}"
                            data-total="{{ order.total_order_amount }}"
                            data-advance="{{ order.advance }}"
                            data-due="{{ order.due_balance }}">
                            Update
                        </a>
                    </span>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="7">No orders found.</td></tr>
            {% endfor %}
        </tbody>
    </table>

        <div class="pagination">
            {% if orders.has_previous %}
                <a href="?page={{ orders.previous_page_number }}">&laquo;</a>
            {% endif %}
            {% for i in orders.paginator.page_range %}
                <a href="?page={{ i }}" class="{% if orders.number == i %}active{% endif %}">{{ i }}</a>
            {% endfor %}
            {% if orders.has_next %}
                <a href="?page={{ orders.next_page_number }}">&raquo;</a>
            {% endif %}
        </div>
    </div>
</div>

<div style="text-align: center; margin-top: 20px;">
            <a href="{% url 'billing' %}">
                <button style="padding: 8px 20px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">Back</button>
            </a>
        </div>
<script>
    function closeModal() {
        document.getElementById('paymentModal').style.display = 'none';
    }

    document.querySelectorAll('.mark-paid-link').forEach(link => {
        link.addEventListener('click', function () {
            const orderId = this.getAttribute('data-order-id');
            const total = parseFloat(this.getAttribute('data-total'));
            const advance = parseFloat(this.getAttribute('data-advance'));
            const due = parseFloat(this.getAttribute('data-due'));

            document.getElementById('popup_order_id').value = orderId;
            document.getElementById('popup_total').value = total.toFixed(2);
            document.getElementById('popup_advance').value = advance.toFixed(2);
            document.getElementById('popup_due').value = due.toFixed(2);

            document.getElementById('paymentForm').action = `/update-payment/${orderId}/`;
            document.getElementById('paymentModal').style.display = 'block';
        });
    });

    document.getElementById('popup_advance').addEventListener('input', function () {
        const total = parseFloat(document.getElementById('popup_total').value) || 0;
        const advance = parseFloat(this.value) || 0;
        const due = total - advance;
        document.getElementById('popup_due').value = due.toFixed(2);
    });

    document.getElementById('popup_paid_now').addEventListener('input', function () {
    const total = parseFloat(document.getElementById('popup_total').value) || 0;
    const currentAdvance = parseFloat(document.getElementById('popup_advance').value) || 0;
    const paidNow = parseFloat(this.value) || 0;

    const due = total - (currentAdvance + paidNow);
    document.getElementById('popup_due').value = due.toFixed(2);
});

</script>
</body>
</html>

{% endblock %}