{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="inventory-edit-wrapper">

    <style>
        .inventory-edit-wrapper h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-size: 28px;
        }

        .inventory-edit-wrapper form {
            max-width: 900px;
            margin: auto;
            background: #f9f9f9;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .inventory-edit-wrapper table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .inventory-edit-wrapper table td {
            padding: 12px 8px;
            vertical-align: middle;
        }

        .inventory-edit-wrapper table td:first-child {
            text-align: right;
            font-weight: bold;
            color: #444;
            width: 35%;
        }

        .inventory-edit-wrapper input[type="text"],
        .inventory-edit-wrapper input[type="number"],
        .inventory-edit-wrapper input[type="date"] {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
            background-color: #fff;
            transition: border 0.3s;
        }

        .inventory-edit-wrapper input:focus {
            border-color: #5b9bd5;
            outline: none;
        }

        .inventory-edit-wrapper .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
            margin-right: 10px;
            transition: background 0.3s;
        }

        .inventory-edit-wrapper .btn-primary {
            background-color: #5b9bd5;
            color: #fff;
        }

        .inventory-edit-wrapper .btn-primary:hover {
            background-color: #4682b4;
        }

        .inventory-edit-wrapper .btn-secondary {
            background-color: #ccc;
            color: #000;
        }

        .inventory-edit-wrapper .btn-secondary:hover {
            background-color: #aaa;
        }

        .inventory-edit-wrapper .form-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
    </style>

    <h2>Edit & Add to Inventory</h2>

    <form method="POST">
        {% csrf_token %}
        <div class="table-responsive">
            <table class="table table-bordered">
                <tbody>
                    <tr><td>Item Id:</td><td><input type="text" name="item_id" id="item_id" value=""></td></tr>
                    <tr><td>Item Name:</td><td><input type="text" name="item_name" id="item_name" value=""></td></tr>
                    <tr><td>Code:</td><td><input type="text" name="code" id="code" value=""></td></tr>
                    <tr><td>Group:</td><td><input type="text" name="group" id="group" value=""></td></tr>
                    <tr><td>Brand:</td><td><input type="text" name="brand" id="brand" value=""></td></tr>
                    <tr><td>Unit:</td><td><input type="text" name="unit" id="unit" value=""></td></tr>
                    <tr><td>Batch No:</td><td><input type="text" name="batch_no" class="form-control" placeholder="Enter Batch Number" required></td></tr>                    
                    <tr><td>Quantity:</td><td><input type="number" step="0.01" name="quantity" id="quantity" class="form-control" placeholder="Enter Quantity" required></td></tr>
                    <tr><td>Split Quantity(Kg/Ltr/Pcs):</td><td><input type="number" step="0.01" name="split_quantity" id="quantity" class="form-control" placeholder="Enter Split Quantity" required></td></tr>
                    <tr><td>Previous Qty:</td><td><input type="number" step="0.01" name="previous_qty" value="0" id="previous_qty"></td></tr>
                    <tr><td>Total Qty:</td><td><input type="number" step="0.01" name="total_qty" id="total_qty" value=""></td></tr>
                    <tr><td>Cost Price:</td><td><input type="number" step="0.01" name="cost_rate" id="cost_rate" value=""></td></tr>
                    <tr><td>Total Price:</td><td><input type="number" step="0.01" name="total_price" id="total_price" readonly></td></tr>
                    <tr><td>Discount:</td><td><input type="number" step="0.01" name="discount" id="discount" value="0"></td></tr>
                    <tr><td>Tax:</td><td><input type="number" step="0.01" name="tax" id="tax" value="0"></td></tr>
                    <tr><td>Net Price:</td><td><input type="number" step="0.01" name="net_price" id="net_price" readonly></td></tr>
                    <tr><td>MRP Price:</td><td><input type="number" step="0.01" name="mrp_price" id="mrp_price" value=""></td></tr>
                    <tr><td>Whole Price:</td><td><input type="number" step="0.01" name="whole_price" id="whole_price" value=""></td></tr>
                    <tr><td>Whole Price 2:</td><td><input type="number" step="0.01" name="whole_price_2" id="whole_price_2" value=""></td></tr>
                    <tr><td>Sale Price:</td><td><input type="number" step="0.01" name="sale_price" id="sale_price" value=""></td></tr>               
                    <tr><td>Expiry Date:</td><td><input type="date" name="expiry_date" class="form-control" required></td></tr>
                    <tr><td>Remarks:</td><td><input type="text" name="remarks" class="form-control" placeholder="Remarks" required></td></tr>
                </tbody>
            </table>
        </div>    

        <div class="form-buttons">
            <button type="submit" class="btn btn-primary">Save to Inventory</button>
            <a href="{% url 'split_stock' %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>

</div>

<script>
    function calculatePrices() {
        const qty = parseFloat(document.getElementById("quantity").value) || 0;
        const unitPrice = parseFloat(document.getElementById("cost_rate").value) || 0;
        const discount = parseFloat(document.getElementById("discount").value) || 0;
        const tax = parseFloat(document.getElementById("tax").value) || 0;

        const totalPrice = qty * unitPrice;
        const netPrice = totalPrice - discount + tax;

        document.getElementById("total_price").value = totalPrice.toFixed(2);
        document.getElementById("net_price").value = netPrice.toFixed(2);
        document.getElementById("total_qty").value = qty;
    }

    document.addEventListener('input', calculatePrices);
    window.onload = calculatePrices;

    document.addEventListener('DOMContentLoaded', function () {
        function fetchItemInfo(queryParam, value) {
            fetch(`/ajax/fetch-item-info/?${queryParam}=${encodeURIComponent(value)}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.error) {
                        document.getElementById('item_id').value = data.item_id || '';
                        document.getElementById('item_name').value = data.item_name || '';
                        document.getElementById('code').value = data.code || '';
                        document.getElementById('group').value = data.group || '';
                        document.getElementById('brand').value = data.brand || '';
                        document.getElementById('unit').value = data.unit || '';
                        document.getElementById('unit_price').value = data.cost_rate || 0;
                        document.getElementById('mrp_price').value = data.mrp_price || 0;
                        document.getElementById('whole_price').value = data.whole_price || 0;
                        document.getElementById('whole_price_2').value = data.whole_price_2 || 0;
                        document.getElementById('sale_price').value = data.sale_price || 0;
                    }
                });
        }

        document.getElementById('code').addEventListener('blur', function () {
            const code = this.value;
            if (code) fetchItemInfo('code', code);
        });

        document.getElementById('item_name').addEventListener('blur', function () {
            const name = this.value;
            if (name) fetchItemInfo('name', name);
        });
    });
</script>
{% endblock %}
