{% extends 'base.html' %}

{% block content %}
<!DOCTYPE html>
<html>
<head>
    <title>Purchase Payment Details</title>
    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            background-color: #f9fafb;
            margin: 0;
            padding: 0;
        }
        h2 {
            text-align: center;
            margin: 30px 0;
            color: #2d3748;
            font-size: 28px;
        }
        .table-container {
            max-width: 1700px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
            font-size: 14px;
        }
        thead {
            background-color: #1e3a8a;
            color: white;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        th, td {
            padding: 12px 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        tbody tr:nth-child(even) {
            background-color: #f8fafc;
        }
        tbody tr:hover {
            background-color: #edf2f7;
            transition: 0.2s;
        }
        .status-paid {
            color: #16a34a;
            font-weight: bold;
        }
        .status-unpaid {
            color: #dc2626;
            font-weight: bold;
        }
        .status-partial {
            color: #d97706;
            font-weight: bold;
        }
        .btn-container {
            text-align: center;
            margin-top: 25px;
        }
        .back-btn {
            padding: 10px 25px;
            background: linear-gradient(to right, #2563eb, #1d4ed8);
            border: none;
            color: white;
            font-size: 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s ease-in-out;
        }
        .back-btn:hover {
            background: linear-gradient(to right, #1d4ed8, #1e40af);
        }
        .status-pending {
            background-color: #f8d7da;
            color: #721c24;
            font-weight: bold;
            text-align: center;
        }

        .status-completed {
            background-color: #d4edda;
            color: #155724;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Purchase Payment Details</h2>   
</div>


<form method="get" id="filterForm" class="mb-3" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
    <label>Supplier:</label>
    <select name="supplier" style="padding: 5px 10px; border-radius: 5px; border: 1px solid #ccc;">
        <option value="">All</option>
        {% for supplier in suppliers %}
            <option value="{{ supplier.id }}" {% if selected_supplier == supplier.id|stringformat:"s" %}selected{% endif %}>
                {{ supplier.name }}
            </option>
        {% endfor %}
    </select>

    <label>Start Date:</label>
    <input type="date" name="start_date" id="start_date" value="{{ start_date }}" style="padding: 5px 10px; border-radius: 5px; border: 1px solid #ccc;">

    <label>End Date:</label>
    <input type="date" name="end_date" id="end_date" value="{{ end_date }}" style="padding: 5px 10px; border-radius: 5px; border: 1px solid #ccc;">


    <button type="submit" style="
        padding: 6px 15px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: 0.3s;
    " 
    onmouseover="this.style.backgroundColor='#45a049';" 
    onmouseout="this.style.backgroundColor='#4CAF50';">
        Filter
    </button>
     <div style="margin-left: auto;">
        <a href="{% url 'purchase' %}">
            <button type="button" class="back-btn" style="padding: 6px 15px; background: linear-gradient(to right, #2563eb, #1d4ed8); color: white; border: none; border-radius: 5px; cursor: pointer; transition: 0.3s;">
                Back
            </button>
        </a>
    </div>
</form>

<div class="table-container">
    <table>
        <thead>
            <tr>         
                <th>S.no</th>      
                <th>Purchase ID</th>
                <th>Supplier ID</th>
                <th>Invoice No</th>
                <th>Subtotal amount</th>
                <th>Tax</th>
                <th>Discount</th>
                <th>Total Invoice Amount</th>               
                <th>Amount Paid</th>
                <th>Outstanding Amount</th>                                          
                <th>Payment Mode</th>
                <th>Payment Rate</th>
                <th>Payment Reference</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>                
            <td>{{ forloop.counter }}</td>
            <td>{{ item.purchase.id }}</td>
            <td>{{ item.purchase.supplier.name }}</td>
            <td>
                <a href="#" class="invoice-link" data-invoice="{{ item.purchase.invoice_no }}">
                    {{ item.purchase.invoice_no }}
                </a>
            </td>          
            <td>{{ item.purchase.subtotal }}</td>
            <td>{{ item.purchase.tax }}</td>
            <td>{{ item.purchase.discount }}</td>
            <td>{{ item.purchase.total_amount }}</td>
            <td>{{ item.purchase.amount_paid }}</td>
            <td>{{ item.purchase.outstanding_amount }}</td>
            <td>{{ item.purchase.payment_mode }}</td>
            <td>{{ item.purchase.payment_rate }}</td>
            <td>{{ item.purchase.payment_reference }}</td>
            <td class="
                {% if item.purchase.outstanding_amount > 0 %}
                    status-pending
                {% else %}
                    status-completed
                {% endif %}
            ">
                {% if item.purchase.outstanding_amount > 0 %}
                    Pending
                {% else %}
                    Completed
                {% endif %}
            </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="11" style="padding: 20px; color: #64748b;">No purchase payments found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Payment Details Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" style="max-width: 1400px !important; width: 90vw !important;">
    <div class="modal-content" style="width: 100%; max-width: 1200px;">
      <div class="modal-header">
        <h5 class="modal-title" id="paymentModalLabel">Payments for Invoice</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>S.no</th>
              <th>Payment Amount</th>
              <th>Payment Mode</th>
              <th>Payment Reference</th>
              <th>Purchase ID</th>
              <th>Payment Date</th>
              <th>Supplier ID</th>
              <th>Balance Amount</th>
              <th>Total Amount</th>
            </tr>
          </thead>
          <tbody id="modalPaymentBody">
            <!-- Payments will be loaded here via JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

</body>
</html>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const invoiceLinks = document.querySelectorAll('.invoice-link');

    invoiceLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const invoiceNo = this.dataset.invoice;

            fetch(`/api/purchase-payments/${invoiceNo}/`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('modalPaymentBody');
                    tbody.innerHTML = '';

                    data.payments.forEach((p, index) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${p.payment_amount}</td>
                            <td>${p.payment_mode}</td>
                            <td>${p.payment_reference}</td>
                            <td>${p.purchase_id}</td>
                            <td>${p.payment_date}</td>
                            <td>${p.supplier_id}</td>
                            <td>${p.balance_amount}</td>
                            <td>${p.total_amount}</td>
                        `;
                        tbody.appendChild(tr);
                    });

                    // Show modal
                    const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
                    paymentModal.show();
                });
        });
    });
});


    document.getElementById("filterForm").addEventListener("submit", function (e) {
        const start = document.getElementById("start_date").value;
        const end = document.getElementById("end_date").value;

        if (start && end && end < start) {
            e.preventDefault();
            alert("⚠️ End date must be greater than or equal to Start date.");
        }
    });

    window.addEventListener("keydown", function(e) {
        if (e.key === "F5") {
        e.preventDefault();
        window.location.href = "{% url 'purchase_items' %}"; // reset on F5
        }
    });
</script>
{% endblock %}