{% extends "base.html" %}

{% block title %}Item Creation{% endblock %}

{% block content %}
<style>
    h2 {
        margin-top: 0;
        text-align: center;
        color: white;
        background-color: #060636;
        padding: 10px;
        border-radius: 10px;
    }

    .container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 10px;
        max-height: 750px; /* set your preferred height */
        overflow-y: auto;  /* adds scroll if content overflows */
    }

    .section {
        background-color: #e0f7fa;
        padding: 15px;
        border-radius: 10px;
        flex: 1;
        min-width: 300px;
    }

    table {
        width: 100%;
        border-spacing: 10px;
    }

    td {
        vertical-align: top;
    }

    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    input[type="text"], select {
        width: 100%;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .buttons {
        text-align: center;
        margin-top: 20px;
    }

    button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        background-color: #00796b;
        color: white;
        border-radius: 5px;
        cursor: pointer;
    }

    button:hover {
        background-color: #004d40;
    }

    .picture-box {
        border: 1px solid #ccc;
        background-color: white;
        width: 100px;
        height: 100px;
        margin-bottom: 10px;
    }

    .modal-backdrop {
    z-index: 1040 !important;
    }
    .modal {
    z-index: 1050 !important;
    }
</style>

<h2>Item Creation</h2>

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert"
         {% if message.tags == 'error' or message.tags == 'danger' %}
           style="color: red;"
         {% endif %}>
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
{% endif %}

<form method="POST">
    {% csrf_token %}
    <div class="container">

        <!-- Item Info -->
        <div class="section">
            <h3>Item Information</h3>
            <table>
                <tr>                    
                    <td>
                        <label>Code</label>
                        <input type="text" id="item_code" name="code" required>
                        <span id="codeAlert" style="color:red; display:none;">Code already exists!</span>
                    </td>
                    <td><label>Status</label>
                        <select name="status">
                            <option>Active</option>
                            <option>Inactive</option>
                        </select>
                    </td>
                </tr>
                <tr><td colspan="2"><label>Item Name</label><input type="text" name="item_name" required></td></tr>
                <tr><td colspan="2"><label>Print Name (optional)</label><input type="text" name="print_name"></td></tr>               
                <tr>
                    <td>
                        <label for="unit">Unit</label>
                        <select name="unit" id="unit">
                            <option value="">-- Select Unit --</option>
                            {% for u in units %}
                                <option value="{{ u.id }}">{{ u.unit_name }}</option>
                            {% endfor %}
                        </select>                      
                    </td>

                    <td>
                        <label for="p_unit">P. Unit</label>
                        <select name="P_unit" id="p_unit">
                            <option value="">-- Select Unit --</option>
                            {% for u in units %}
                                <option value="{{ u.id }}">{{ u.unit_name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>

                <tr>
                <td colspan="2">
                    <label for="group">Group</label>
                    <div class="d-flex align-items-center gap-2">
                        <select name="group" id="group" class="form-select" required>
                        <option value="">-- Select Group --</option>
                        {% for g in groups %}
                            <option value="{{ g.id }}">{{ g.group_name }}</option>
                        {% endfor %}
                        </select>                        
                    </div>
                    </td>
            </tr>
    
                <tr>
                    <td colspan="2">
                        <label for="brand">Brand</label>
                        <select name="brand" id="brand">
                            <option value="">-- Select Brand --</option>
                            {% for b in brands %}
                                <option value="{{ b.id }}">{{ b.brand_name }}</option>
                            {% endfor %}
                        </select>                      
                    </td>
                </tr>
                 <tr>
                    <td colspan="2">
                        <label for="tax">Tax</label>
                      <select name="tax" id="tax" required>
                        <option value="">-- Select Tax --</option>
                        {% for tax in taxes %}
                            <option value="{{ tax.id }}">{{ tax.tax_name }}</option>
                        {% endfor %}
                      </select>
                    </td>
                </tr>                              
                <tr><td colspan="2"><label>HSN / SAC</label><input type="text" name="hsn_sac" required></td></tr>
                <tr>
                    <td><label>Use MRP</label>
                        <select name="use_mrp">
                            <option>Yes</option>
                            <option selected>No</option>
                        </select>
                    </td>
                    <td><label>Points</label><input type="text" name="points"></td>
                </tr>
                <tr><td colspan="2"><label>Cess Per Qty</label><input type="text" name="cess_per_qty"></td></tr>
            </table>
        </div>

        <!-- Pricing -->
        <div class="section">
            <h3>Pricing Details</h3>
            <table>
                <tr><td><label>P. Rate</label><input type="text" name="p_rate"></td></tr>
                <tr><td><label>Cost Rate</label><input type="text" name="cost_rate"></td></tr>
                <tr><td><label>MRP</label><input type="text" name="mrp"></td></tr>
                <tr><td><label>Sale Rate</label><input type="text" name="sale_rate"></td></tr>
                <tr><td><label>Whole Rate</label><input type="text" name="whole_rate"></td></tr>
                <tr><td><label>Whole Rate 2</label><input type="text" name="whole_rate2"></td></tr>
                <tr><td><label>Min Stock</label><input type="text" name="min_stock"></td></tr>
            </table>

             <label>Carry Over</label>
            <select name="carry_over">
                <option disabled selected>Select Carry Over</option>
                <option>Yes</option>
                <option>No</option>
            </select>

            <label>Manual</label>
            <select name="manual">
                <option disabled selected>Select Manual</option>
                <option>Yes</option>
                <option>No</option>
            </select>

            <label>Stock Item</label>
            <select name="stock_item">
                <option disabled selected>Select Stock Item</option>
                <option>Yes</option>
                <option>No</option>
            </select>
        </div>                
    </div>
    
    <!-- Action Buttons -->
    <div class="buttons">
        <a href="{% url 'items_list' %}" 
        style="display:inline-block; padding:8px 16px; background-color:#105592; 
                color:white; text-decoration:none; border:none; border-radius:5px; font-size:14px;">
            Item Unit's
        </a>        

         <!-- Button to open modal -->
        <button type="button" data-bs-toggle="modal" data-bs-target="#unitModal">
            + Add Unit
        </button>
        <button type="button" data-bs-toggle="modal" data-bs-target="#groupModal">
            + Add Group
        </button>        
        <button type="button" data-bs-toggle="modal" data-bs-target="#brandModal">
            + Add Brand
        </button>       
    
        <a href="{% url 'tax_creation' %}">
            <button type="button">Tax</button>
        </a>
        <div class="btn-container" style="margin-top:15px;">
            <button type="submit" id="saveBtn" 
                    style="background-color:#28a745; color:white; padding:8px 16px; 
                        border:none; border-radius:5px; font-size:14px;">
                Save
            </button>
            
            <button type="button" onclick="window.location.href='{% url 'dashboard' %}'" 
                    style="background-color:#dc3545; color:white; padding:8px 16px; 
                        border:none; border-radius:5px; font-size:14px;">
                Exit
            </button>
            
            <button type="reset" 
                    style="background-color:#ffc107; color:black; padding:8px 16px; 
                        border:none; border-radius:5px; font-size:14px;">
                Reset
            </button>
        </div>
    </div>
</form>
</div>

<!-- ======= unit creation modal ======= -->
<div class="modal fade" id="unitModal" tabindex="-1" aria-labelledby="unitModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="unitForm" novalidate>
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="unitModalLabel">Create Unit</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label" for="unit_name">Unit Name</label>
            <input id="unit_name" type="text" name="unit_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label" for="print_name">Print Name</label>
            <input id="print_name" type="text" name="print_name" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label" for="decimals">Decimals</label>
            <input id="decimals" type="number" step="0.01" name="decimals" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label" for="UQC">UQC</label>
            <input id="UQC" type="text" name="UQC" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Group Creation Modal -->
<div class="modal fade" id="groupModal" tabindex="-1" aria-labelledby="groupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="POST" id="groupModalForm">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="groupModalLabel">Group Creation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Group Name:</label>
            <input type="text" name="group_name" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Alias Name:</label>
            <input type="text" name="alias_name" class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label">Under:</label>
            <input type="text" name="under" class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label">Print Name:</label>
            <input type="text" name="print_name" class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label">Commodity:</label>
            <input type="text" name="commodity" class="form-control">
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Brand Creation Modal -->
<div class="modal fade" id="brandModal" tabindex="-1" aria-labelledby="brandModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="brandModalForm" method="POST">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="brandModalLabel">Brand Creation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Brand Name</label>
            <input type="text" name="brand_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Alias Name</label>
            <input type="text" name="alias_name" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Under</label>
            <input type="text" name="under" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Print Name</label>
            <input type="text" name="print_name" class="form-control">
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('form');
    const saveBtn = document.getElementById('saveBtn');

    // Before save confirmation
    saveBtn.addEventListener('click', function(e) {
        const confirmed = confirm("Are you sure you want to save?");
        if (!confirmed) {
            e.preventDefault();
        }
    });

    // After save success messages
    const messagesScript = document.getElementById('djangoMessages');
    if (messagesScript) {
        const messages = JSON.parse(messagesScript.textContent);
        messages.forEach(msg => {
            alert(msg.message);  // Show alert for each message
        });
    }
});

document.getElementById("saveBtn").addEventListener("click", function(event) {
    let confirmSave = confirm("Are you sure you want to save?");
    if (!confirmSave) {
        event.preventDefault();
    }
});

document.getElementById("item_code").addEventListener("blur", function() {
    const codeInput = this;
    const code = codeInput.value.trim();
    if (code === "") return;

    fetch(`/check-item-code/?code=${encodeURIComponent(code)}`)
        .then(response => response.json())
        .then(data => {
            if (data.exists) {
                // Show warning and block movement
                document.getElementById("codeAlert").style.display = "inline";
                codeInput.style.borderColor = "red";
                document.querySelector("button[type='submit']").disabled = true;

                // Focus back to input
                setTimeout(() => codeInput.focus(), 0);

                // Block tab key temporarily
                codeInput.addEventListener('keydown', blockTab, true);
            } else {
                // Code is unique, allow normal interaction
                document.getElementById("codeAlert").style.display = "none";
                codeInput.style.borderColor = "";
                document.querySelector("button[type='submit']").disabled = false;

                // Remove the tab-blocking listener
                codeInput.removeEventListener('keydown', blockTab, true);
            }
        })
        .catch(error => console.error("Error:", error));
});

// Function to block tab key when code exists
function blockTab(e) {
    if (e.key === "Tab") {
        e.preventDefault();
    }
}

document.getElementById("unitForm").addEventListener("submit", function(e) {
    e.preventDefault();

    let formData = new FormData(this);

    fetch("{% url 'unit_creation' %}", {
        method: "POST",
        headers: { 
            "X-CSRFToken": "{{ csrf_token }}",
            "X-Requested-With": "XMLHttpRequest"
        },
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Update both dropdowns (#unit and #p_unit)
            ["unit", "p_unit"].forEach(id => {
                let dropdown = document.getElementById(id);
                if (dropdown) {
                    let option = document.createElement("option");
                    option.value = data.id;
                    option.textContent = data.name;
                    dropdown.appendChild(option);

                    // auto-select the new unit
                    option.selected = true;
                }
            });

            // Close modal
            var modal = bootstrap.Modal.getInstance(document.getElementById('unitModal'));
            modal.hide();

            this.reset();
        } else {
            alert("Error creating unit!");
        }
    });
});

document.getElementById("groupModalForm").addEventListener("submit", function(e) {
    e.preventDefault();

    let formData = new FormData(this);

    fetch("{% url 'group_creation' %}", {
        method: "POST",
        body: formData,
        headers: {
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add new option to dropdown
            let groupSelect = document.getElementById("group");
            let newOption = document.createElement("option");
            newOption.value = data.id;
            newOption.text = data.name;
            newOption.selected = true;
            groupSelect.appendChild(newOption);
           
            let modal = bootstrap.Modal.getInstance(document.getElementById("groupModal"));
            modal.hide();
         
            document.getElementById("groupModalForm").reset();
        } else {
            alert(data.error || "Failed to create group");
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Something went wrong. Please try again.");
    });
});

document.getElementById("brandModalForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    fetch("{% url 'brand_creation' %}", {
        method: "POST",
        body: formData,
        headers: {
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let brandSelect = document.getElementById("brand"); // your brand dropdown ID
            let option = document.createElement("option");
            option.value = data.id;
            option.text = data.name;
            option.selected = true;
            brandSelect.add(option);

            // close modal
            let modal = bootstrap.Modal.getInstance(document.getElementById("brandModal"));
            modal.hide();

            this.reset();
        }
    })
    .catch(err => console.error(err));
});

document.getElementById("brand").addEventListener("change", function() {
    const brandSelect = this;
    const barcodeInput = document.getElementById("barcode");
    const codeInput = document.getElementById("item_code");

    // Only generate barcode if Mahil is selected
    const selectedBrand = brandSelect.options[brandSelect.selectedIndex].text.trim().toLowerCase();
    if (selectedBrand === "mahil") {
        const itemCode = codeInput.value.trim();
        if (itemCode) {
            barcodeInput.value = "890" + itemCode;
        } else {
            barcodeInput.value = "";
        }
    }
});
</script>
{% endblock %}