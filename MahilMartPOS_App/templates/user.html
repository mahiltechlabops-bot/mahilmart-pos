{% extends 'base.html' %}

{% block content %}
<main class="app-content d-flex justify-content-center" id="mainContent">
  <div class="form-container w-100" style="max-width: 900px;">
    <h2>User Creation</h2>

    {% if error %}
      <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i> {{ error }}
      </div>
    {% endif %}

    {% if success %}
      <div class="alert alert-success">
        <i class="fas fa-check-circle"></i> Registration successful!
        {% if can_edit_bill or can_print_previous_bills or dashboard_access %}
          <div class="mt-3">
            <strong>Assigned Permissions:</strong>
            <ul>
              {% if can_edit_bill %}<li><i class="fas fa-edit"></i> Can Edit Bill</li>{% endif %}
              {% if can_print_previous_bills %}<li><i class="fas fa-print"></i> Can Print Previous Bills</li>{% endif %}
              {% if dashboard_access %}<li><i class="fas fa-tachometer-alt"></i> Dashboard Access</li>{% endif %}
            </ul>
          </div>
        {% endif %}
      </div>
    {% endif %}

    <form method="post" novalidate>
      {% csrf_token %}

      <!-- Username -->
      <label for="username">Username</label>
      <div class="input-group mb-3">
        <span class="input-group-text"><i class="fas fa-user"></i></span>
        <input type="text" id="username" name="username" class="form-control" value="{{ username|default:'' }}" placeholder="Enter username" required>
      </div>

      <!-- Email -->
      <label for="email">Email</label>
      <div class="input-group mb-3">
        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
        <input type="email" id="email" name="email" class="form-control" value="{{ email|default:'' }}" placeholder="Enter email" required>
      </div>

      <!-- Phone -->
      <label for="phone_number">Phone Number</label>
      <div class="input-group mb-3">
        <span class="input-group-text"><i class="fas fa-phone"></i></span>
        <input type="tel" id="phone_number" name="phone_number" pattern="[6-9]{1}[0-9]{9}" maxlength="10" class="form-control" value="{{ phone_number|default:'' }}" placeholder="Enter 10-digit mobile number" required>
      </div>

      <!-- Role -->
      <label for="role">Role</label>
      <div class="input-group mb-3">
        <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
        <select id="role" name="role" class="form-select" required>
          <option value="">-- Select Role --</option>
          <option value="ADMIN" {% if role == 'ADMIN' %}selected{% endif %}>Admin</option>
          <option value="CASHIER" {% if role == 'CASHIER' %}selected{% endif %}>Cashier</option>
          <option value="MANAGER" {% if role == 'MANAGER' %}selected{% endif %}>Manager</option>
        </select>
      </div>

      <!-- Status -->
      <label for="status">Status</label>
      <div class="input-group mb-3">
        <span class="input-group-text"><i class="fas fa-toggle-on"></i></span>
        <select id="status" name="status" class="form-select" required>
          <option value="">-- Select Status --</option>
          <option value="ACTIVE" {% if status == 'ACTIVE' %}selected{% endif %}>Active</option>
          <option value="INACTIVE" {% if status == 'INACTIVE' %}selected{% endif %}>Inactive</option>
        </select>
      </div>

      <!-- Password -->
      <label for="password">Password</label>
      <div class="input-group mb-3">
        <span class="input-group-text"><i class="fas fa-lock"></i></span>
        <input type="password" id="password" name="password" class="form-control" minlength="8" placeholder="Enter password" required>
      </div>

      <div class="password-strength">
        <div class="password-strength-bar" id="password-strength-bar" style="height: 6px;"></div>
      </div>

      <div id="password-alert" class="alert alert-warning d-none mt-2">
        <strong>Password must contain:</strong>
        <ul class="mb-0">
          <li>Minimum 8 characters</li>
          <li>At least one uppercase letter</li>
          <li>At least one lowercase letter</li>
          <li>At least one number</li>
          <li>At least one special character</li>
        </ul>
      </div>

      <!-- Confirm Password -->
      <label for="confirm_password">Confirm Password</label>
      <div class="input-group mb-3">
        <span class="input-group-text"><i class="fas fa-lock"></i></span>
        <input type="password" id="confirm_password" name="confirm_password" class="form-control" placeholder="Re-enter password" required>
      </div>

      <!-- Permissions -->
      <div id="permissions-section" class="mb-3" style="margin-top: 20px;">
        <label><strong>Permissions:</strong></label>
        <div class="form-check">
          <input type="checkbox" id="can_edit_bill" name="can_edit_bill" class="form-check-input" {% if can_edit_bill %}checked{% endif %}>
          <label class="form-check-label" for="can_edit_bill">Can Edit Bill</label>
        </div>
        <div class="form-check">
          <input type="checkbox" id="can_print_previous_bills" name="can_print_previous_bills" class="form-check-input" {% if can_print_previous_bills %}checked{% endif %}>
          <label class="form-check-label" for="can_print_previous_bills">Can Print Previous Bills</label>
        </div>
        <div class="form-check">
          <input type="checkbox" id="dashboard_access" name="dashboard_access" class="form-check-input" {% if dashboard_access %}checked{% endif %}>
          <label class="form-check-label" for="dashboard_access">Dashboard Access</label>
        </div>
      </div>

      <button type="submit" class="btn btn-success mt-3"><i class="fas fa-user-plus"></i> Register</button>
    </form>
  </div>
</main>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
  const passwordInput = document.getElementById('password');
  const confirmPassword = document.getElementById('confirm_password');
  const passwordBar = document.getElementById('password-strength-bar');
  const passwordAlert = document.getElementById('password-alert');

  passwordInput.addEventListener('input', function () {
    const password = passwordInput.value;
    let strength = 0;

    if (password.length >= 8) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[a-z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^A-Za-z0-9]/.test(password)) strength++;

    let width = strength * 20;
    let color = ['#dc3545', '#ffc107', '#28a745'][Math.floor(strength / 2)];

    passwordBar.style.width = width + '%';
    passwordBar.style.backgroundColor = color || '#dc3545';

    if (password.length > 0) {
      passwordAlert.classList.remove('d-none');
    } else {
      passwordAlert.classList.add('d-none');
    }
  });

  confirmPassword.addEventListener('input', function () {
    if (confirmPassword.value !== passwordInput.value) {
      confirmPassword.setCustomValidity("Passwords do not match");
    } else {
      confirmPassword.setCustomValidity("");
    }
  });

  const roleSelect = document.getElementById('role');
  const permissions = document.getElementById('permissions-section');
  roleSelect.addEventListener('change', () => {
    if (['ADMIN', 'MANAGER'].includes(roleSelect.value)) {
      permissions.style.display = 'block';
    } else {
      permissions.style.display = 'none';
    }
  });

  if (!['ADMIN', 'MANAGER'].includes(roleSelect.value)) {
    permissions.style.display = 'none';
  }

  {% if success %}
  Toastify({
    text: "User created successfully!",
    duration: 5000,
    close: true,
    gravity: "top",
    position: "center",
    backgroundColor: "linear-gradient(to right, #28a745, #218838)",
    stopOnFocus: true
  }).showToast();
  {% endif %}
</script>
{% endblock %}
