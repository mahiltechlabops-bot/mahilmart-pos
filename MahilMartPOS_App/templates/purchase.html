{% extends "base.html" %}
{% block style %}
<style>
  #purchaseTable input {
    width: 80px;       
    padding: 4px 6px;
    font-size: 13px;
    box-sizing: border-box;
  }

  #purchaseTable td,
  #purchaseTable th {
    white-space: wrap;   
    font-size: 13px;
    padding: 2px 4px !important;
    line-height: 1.1;
    font-size: 0.8rem;
  }

   /* Reduce table min width */
  #purchaseTable {
    min-width: auto !important;
    width: 100%;
    table-layout: auto;
  }

  /* Make header text compact */
  #purchaseTable th {
    font-weight: 600;
    text-align: center;
  }

  /* Optional: fix row height */
  #purchaseTable tbody tr {
    height: 24px;
  }

  .table-responsive {
    overflow-x: hidden;
  }

  #purchaseTable {
    width: 100%;
    table-layout: auto;
  }

  #purchaseTable td:nth-child(1) input,
  #purchaseTable td:nth-child(3) input,
  #purchaseTable td:nth-child(4) input,
  #purchaseTable td:nth-child(5) input,
  #purchaseTable td:nth-child(6) input,
  #purchaseTable td:nth-child(7) input,
  #purchaseTable td:nth-child(8) input,
  #purchaseTable td:nth-child(9) input,
  #purchaseTable td:nth-child(10) input,
  #purchaseTable td:nth-child(11) input,
  #purchaseTable td:nth-child(12) input,
  #purchaseTable td:nth-child(13) input,
  #purchaseTable td:nth-child(14) input,
  #purchaseTable td:nth-child(15) input,
  #purchaseTable td:nth-child(16) input,
  #purchaseTable td:nth-child(17) input,
  #purchaseTable td:nth-child(18) input, 
  #purchaseTable td:nth-child(19) input, 
  #purchaseTable td:nth-child(20) input{
    width: 50px !important;
    padding: 3px 4px;
    font-size: 12px;
    box-sizing: border-box;
  }

  #purchaseTable td:nth-child(2) input,    
  #purchaseTable td:nth-child(21) input {
    width: 100px !important;
    padding: 3px 4px;
    font-size: 12px;
    box-sizing: border-box;
  }

/* Allow table header text wrapping */
#purchaseTable thead th {
    white-space: normal;
    word-break: break-word;
    font-size: 0.75rem;
    padding: 4px 6px;
    text-align: center;
    vertical-align: middle;
}

/* Remove up/down arrows for all targeted number inputs */
.unit_qty::-webkit-inner-spin-button,
.unit_qty::-webkit-outer-spin-button,
.split_unit::-webkit-inner-spin-button,
.split_unit::-webkit-outer-spin-button,
.split_unit_price::-webkit-inner-spin-button,
.split_unit_price::-webkit-outer-spin-button,
.discount::-webkit-inner-spin-button,
.discount::-webkit-outer-spin-button,
.taxable_price::-webkit-inner-spin-button,
.taxable_price::-webkit-outer-spin-button,
.price::-webkit-inner-spin-button,
.price::-webkit-outer-spin-button,
.cost_price::-webkit-inner-spin-button,
.cost_price::-webkit-outer-spin-button,
.qty::-webkit-inner-spin-button,
.qty::-webkit-outer-spin-button,
.tax::-webkit-inner-spin-button,
.tax::-webkit-outer-spin-button,
.mrp::-webkit-inner-spin-button,
.mrp::-webkit-outer-spin-button,
.whole_price::-webkit-inner-spin-button,
.whole_price::-webkit-outer-spin-button,
.whole_price_2::-webkit-inner-spin-button,
.whole_price_2::-webkit-outer-spin-button,
.sale_price::-webkit-inner-spin-button,
.sale_price::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.unit_qty,
.split_unit,
.split_unit_price,
.discount,
.taxable_price,
.price,
.cost_price,
.qty,
.tax,
.mrp,
.whole_price,
.whole_price_2,
.sale_price {
    -moz-appearance: textfield;
}

 .suggestion-list {
        position: absolute;
        background: rgb(219, 212, 212);
        border: 1px solid #571414;
        z-index: 1000;
        max-height: 150px;
        overflow-y: auto;
        width: 10%;
        list-style: none;
        margin: 0;
        padding: 0;
        }

        .suggestion-list li {
        padding: 6px 10px;
        cursor: pointer;
        }

        .suggestion-list li:hover {
        background: #f0f0f0;
        }
</style>

{% endblock %}

{% block content %}
<main class="app-content">
  <div class="card p-4 mx-auto container-fluid">
    <h3><i class="fas fa-truck-loading"></i> New Purchase</h3>

     <div class="d-flex justify-content-end gap-2">

        <a href="{% url 'daily_purchase_payment' %}" class="btn btn-secondary" style="background-color: #007bff; color: white;">Daily Purchase Payment Entry</a>
        <a href="{% url 'purchase_payment_list' %}" class="btn btn-primary btn-sm" target="_blank" style="background-color: #095a5a83; color: white;">
          Purchase Payment
        </a>
        <a href="{% url 'items' %}" class="btn btn-primary btn-sm" target="_blank" style="background-color: #39ac16; color: white;">
          Item creation
        </a>
        <a href="{% url 'purchase_items' %}" class="btn btn-primary btn-sm">
          Purchase Payment Details
        </a>
        <a href="{% url 'purchase_list' %}" class="btn btn-primary btn-sm">
          View Purchase Details
        </a>
         <a href="{% url 'purchase_update_tracking' %}" class="btn btn-primary btn-sm">
          View Purchase Update Tracking Details
        </a>
      </div>

    <!-- Purchase Header -->
    <div class="row mb-4">
      <div class="col-md-6">
        <label>Select Supplier</label>
        <input list="dealerOptions" id="dealerSelect" class="form-control" placeholder="Type supplier name or phone">
        <datalist id="dealerOptions">
          {% for supplier in suppliers %}
          <option value="{{supplier.name}} ({{supplier.phone}})"
                  data-id="{{supplier.id}}"
                  data-contact="{{supplier.contact_person}}"
                  data-email="{{supplier.email}}"
                  data-address="{{supplier.address}}"
                  data-supplier="{{supplier.supplier_id}}"
                  data-account="{{supplier.account_number}}"
                  data-pan="{{supplier.pan_number}}"
                  data-bank="{{supplier.bank_name}}"
                  data-credit="{{supplier.credit_terms}}"
                  data-gst="{{supplier.gst_number}}"
                  data-ifsc="{{supplier.ifsc_code}}">
          {% endfor %}
        </datalist>
      </div>
      <div class="col-md-6">
        <label>Invoice Number</label>
        <input type="text" id="invoiceNumber" class="form-control" placeholder="Invoice No">
      </div>
    </div>

    <!-- Two-column Supplier Details -->
    <div class="row mb-3" id="supplierDetails" style="display:none;">
      <div class="col-md-12">
        <h6><b>Supplier Details:</b></h6>
        <div class="row">
          <div class="col-md-6">
            <div><b>Contact Person:</b> <span id="supplierContact"></span></div>
            <div><b>Phone:</b> <span id="supplierPhone"></span></div>
            <div><b>Email:</b> <span id="supplierEmail"></span></div>
            <div><b>Address:</b> <span id="supplierAddress"></span></div>
            <div><b>Supplier Id:</b> <span id="supplierSupplierId"></span></div>
            
          </div>
          <div class="col-md-6">
            <div><b>Bank:</b> <span id="supplierBank"></span></div>
            <div><b>Account #:</b> <span id="supplierAccount"></span></div>
            <div><b>Pan #:</b> <span id="supplierPan"></span></div>
            <div><b>IFSC:</b> <span id="supplierIFSC"></span></div>
            <div><b>GST No:</b> <span id="supplierGST"></span></div>
            <div><b>Credit Terms:</b> <span id="supplierCredit"></span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Products Table -->
    <h5>Add Products</h5>
        <div class="table-responsive" style="overflow-x: auto; max-width: 100%;">
          <table class="table table-sm table-bordered mt-3" id="purchaseTable" style="min-width: 1500px; font-size: 0.85rem;">
            <thead class="table-light">
              <tr>
                <th style="white-space: nowrap;">S.no</th><th>Item</th><th>Code</th><th>HSN</th><th>Unit</th>
                <th>Qty</th><th>U-Qty</th><th>Total U-Qty</th><th>Split U-Price</th><th>Unit Price</th><th>Amount</th><th>Discount</th><th>Taxable Amt</th><th>Tax</th><th>Cost Price</th><th>MRP</th><th>Wh</th><th>Wh 1</th>
                <th>Sale Price</th><th>Total Net</th><th>Expiry Date</th><th>Action</th>
              </tr>
            </thead>
            <tbody id="productTableBody"></tbody>
          </table>
       </div>
    <button id="addProductBtn" class="btn btn-primary">+ Add Product</button>

    <!-- Purchase Summary -->
<div class="row mt-5">
  <div class="col-md-12">
    <h5 class="text-center">Purchase Summary</h5>
    <div class="row">
      
      <!-- Left Side -->
      <div class="col-md-6">
        <table class="table summary-table">
          <tr>
            <td>Subtotal:</td>
            <td>₹ <span id="subtotal">0.00</span></td>
          </tr>
          <tr>
            <td>Tax:</td>
            <td>₹ <span id="tax">0.00</span></td>
          </tr>
          <tr>
            <td>Discount:</td>
            <td>₹ <span id="discount">0.00</span></td>
          </tr>
          <tr>
            <td><strong>Total:</strong></td>
            <td><strong>₹ <span id="total">0.00</span></strong></td>
          </tr>         
          <tr>
            <td>Current Paid:</td>
            <td>
              <input type="number" id="current-paid" value="0" min="0" step="0.01" 
                    style="width:100px; padding:4px; border:1px solid #ccc; border-radius:4px;">
            </td>
          </tr>
        </table>
      </div>
      
          <!-- Right Side -->
          <div class="col-md-6">
            <table class="table summary-table">
              <tr>
                <td>Amount Paid ₹:</td>
                <td>
                  <input type="number" id="amount-paid" class="form-control form-control-sm" step="0.01" min="0" value="0.00" readonly>
                </td>
              </tr>
              <tr>
              <td>Outstanding Amount:</td>
              <td>₹ <span id="outstanding-amount" style="font-weight:bold; color:red;">0.00</span></td>
            </tr>

              <tr>
                <td>Payment Mode:</td>
                <td>
                  <select id="payment-mode" class="form-control form-control-sm">
                    <option value="">-- Select --</option>
                    <option value="Cash">Cash</option>
                    <option value="Credit">Credit</option>
                    <option value="Partial Credit">Partial Credit</option>
                    <option value="Card">Card</option>
                    <option value="UPI">UPI</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>Payment Reference:</td>
                <td>
                  <input type="text" id="payment-reference" class="form-control form-control-sm" placeholder="e.g., UPI ID / Transaction ID">
                </td>
              </tr>
              <tr>
                <td>Payment Rate:</td>
                <td><span id="payment-rate">0%</span></td>
              </tr>
              <tr>
                <td>Bill Attachment:</td>
                <td>
                  <input type="file" id="bill-attachment" class="form-control form-control-sm">
                </td>
              </tr>
            </table>
          </div>
          
        </div>
      </div>
    </div>

    <div class="mt-4 d-flex gap-2">
      <button id="completePurchaseBtn" class="btn btn-success">Complete Purchase</button>
      <button id="cancelPurchaseBtn" class="btn btn-secondary">Cancel</button>      
    </div>       
  </div>
  
</main>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const productTableBody = document.getElementById("productTableBody");
  const addProductBtn = document.getElementById("addProductBtn");
  const dealerInput = document.getElementById("dealerSelect");
  const invoiceInput = document.getElementById("invoiceNumber");
  const supplierDetails = document.getElementById("supplierDetails");

  function updateSerials() {
    productTableBody.querySelectorAll('tr').forEach((r,i)=> r.querySelector('.sno').textContent=i+1);
  }

  addProductBtn.addEventListener("click", () => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="sno"></td>
      <td><input class="form-control item-name" onblur="fetchItemDetails(this)"></td>
      <td><input class="form-control item-code" onblur="fetchItemDetails(this)"></td>
      <td><input class="form-control hsn" readonly></td>    
      <td><input class="form-control unit" readonly></td>
      <td><input type="number" class="form-control qty" value="1" min="1" oninput="calculateRow(this.closest('tr'))"></td>   
      <td><input type="number" class="form-control unit_qty" value="0" readonly oninput="calculateRow(this.closest('tr'))"></td>
      <td><input type="number" class="form-control split_unit" value="0"" readonly></td>
      <td><input type="number" class="form-control split_unit_price" value="0"" readonly></td>
      <td><input type="number" class="form-control price" value="0" step="0.01" oninput="calculateRow(this.closest('tr'))"></td>
      <td><input class="form-control total"></td>
      <td><input type="number" class="form-control discount" value="0" step="0.01" oninput="calculateRow(this.closest('tr'))"></td>
      <td><input type="number" class="form-control taxable_price" value="0" step="0.01" oninput="calculateRow(this.closest('tr'))"></td> 
      <td><input type="number" class="form-control tax" value="0" step="0.01" oninput="calculateRow(this.closest('tr'))"></td>           
      <td><input type="number" class="form-control cost_price" value="0" step="0.01" oninput="calculateRow(this.closest('tr'))"></td>
      <td><input type="number" class="form-control mrp" value="0" step="0.01"></td>
      <td><input type="number" class="form-control whole_price" value="0" step="0.01"></td>
      <td><input type="number" class="form-control whole_price_2" value="0" step="0.01"></td>
      <td><input type="number" class="form-control sale_price" value="0" step="0.01"></td>
      <td><input class="form-control net_price" readonly></td>       
      <td><input type="date" class="form-control expiry_date"></td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this)">Delete</button></td>`;
    productTableBody.appendChild(row);
    attachRecalcListeners(row);
    updateSerials();
    calculateRow(row);

    const itemInput = row.querySelector('.item-name');
    if (itemInput) itemInput.focus();
  });

  // Initially disable invoice number until supplier is selected
  invoiceInput.disabled = true;

  // populate supplier details
  dealerInput.addEventListener("input", () => {
    const opt = Array.from(document.getElementById("dealerOptions").options)
      .find(o => o.value === dealerInput.value);
    if (opt) {
      supplierDetails.style.display = "block";
      invoiceInput.disabled = false;
      document.getElementById("supplierContact").textContent = opt.dataset.contact;
      document.getElementById("supplierPhone").textContent = dealerInput.value.match(/\((.+)\)/)?.[1]||"";
      document.getElementById("supplierEmail").textContent = opt.dataset.email;
      document.getElementById("supplierAddress").textContent = opt.dataset.address;
      document.getElementById("supplierSupplierId").textContent = opt.dataset.supplier;
      document.getElementById("supplierBank").textContent = opt.dataset.bank;
      document.getElementById("supplierAccount").textContent = opt.dataset.account;
      document.getElementById("supplierPan").textContent = opt.dataset.pan;
      document.getElementById("supplierIFSC").textContent = opt.dataset.ifsc;
      document.getElementById("supplierGST").textContent = opt.dataset.gst;
      document.getElementById("supplierCredit").textContent = opt.dataset.credit;
    } else {
      supplierDetails.style.display = "none";
      invoiceInput.disabled = true;
      invoiceInput.value = ""; 
    }
  });

  document.getElementById("cancelPurchaseBtn").addEventListener("click", () => {
    if (confirm("Clear all purchase items?")) {
      productTableBody.innerHTML = "";
      updateTotals();
    }
  });

  document.getElementById("completePurchaseBtn").addEventListener("click", () => {
    const opt = Array.from(document.getElementById("dealerOptions").options)
      .find(o => o.value === dealerInput.value);
    if (!opt || invoiceInput.value.trim()==="") {
      return alert("Please select a supplier and enter invoice number.");
    }

    const rows = document.querySelectorAll('#productTableBody tr');

    // Stop if no rows are present
    if (rows.length === 0) {
      alert("Please add at least one product before saving the purchase.");
      return;
    }

     // Validation: every row must have values (expiry date optional)
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];

        const itemName = row.querySelector('.item-name').value.trim();
        const itemCode = row.querySelector('.item-code').value.trim();
        const qty = parseFloat(row.querySelector('.qty').value) || 0;
        const price = parseFloat(row.querySelector('.price').value) || 0;
        const amount = parseFloat(row.querySelector('.total').value) || 0;

        // Bulk unit special check — use .value
        const unit = (row.querySelector('.unit')?.value || '').toLowerCase();
        const splitUnitInput = row.querySelector('.split_unit');
        if (unit.includes('bulk')) {
            const val = parseFloat(splitUnitInput.value);
            if (!val || val === 0) {
                alert(`Row ${i+1}: For BULK units, Split Unit must be greater than 0.`);
                splitUnitInput.focus();
                return;
            }
        }

        // Required field check
        if (!itemName || !itemCode || qty <= 0 || price <= 0 || amount <= 0) {
            alert(`Row ${i+1}: Please fill all required fields (Qty, Price, Amount, Item Code & Name)`);
            return;
        }
    }

    const items = Array.from(productTableBody.querySelectorAll('tr')).map(r => ({
      item_name: r.querySelector('.item-name').value,
      item_code: r.querySelector('.item-code').value,
      hsn: r.querySelector('.hsn').value, 
      quantity: r.querySelector('.qty').value,
      unit_qty: r.querySelector('.unit_qty').value,
      split_unit: r.querySelector('.split_unit').value,
      split_unit_price: r.querySelector('.split_unit_price').value,
      price: r.querySelector('.price').value,
      total_price: r.querySelector('.total').value,
      discount: r.querySelector('.discount').value,
      tax: r.querySelector('.tax').value,
      taxable_price: r.querySelector('.taxable_price').value,
      cost_price: r.querySelector('.cost_price').value,
      net_price: r.querySelector('.net_price').value,
      mrp: r.querySelector('.mrp').value,
      whole_price: r.querySelector('.whole_price').value,
      whole_price_2: r.querySelector('.whole_price_2').value,
      sale_price: r.querySelector('.sale_price').value,  
      expiry_date: r.querySelector('.expiry_date').value
    }));

    // Collect summary + payment fields
    const subtotal = document.getElementById("subtotal").innerText;
    const discount = document.getElementById("discount").innerText;
    const tax = document.getElementById("tax").innerText;
    const total = document.getElementById("total").innerText;
    const amountPaid = document.getElementById("amount-paid").value;
    const outstanding = document.getElementById("outstanding-amount").innerText;
    const paymentRate = document.getElementById("payment-rate").innerText;
    const paymentMode = document.getElementById("payment-mode").value;
    const paymentRef = document.getElementById("payment-reference").value;
    const billAttachment = document.getElementById("bill-attachment").files[0];

    // Use FormData for file + JSON mix
    const formData = new FormData();
    formData.append("supplier_id", opt.dataset.id);    
    formData.append("invoice_no", invoiceInput.value.trim());
    formData.append("subtotal", subtotal);
    formData.append("discount", discount);
    formData.append("tax", tax);
    formData.append("total", total);
    formData.append("amount_paid", amountPaid);
    formData.append("outstanding", outstanding);
    formData.append("payment_rate", paymentRate);
    formData.append("payment_mode", paymentMode);
    formData.append("payment_reference", paymentRef);

    if (billAttachment) {
      formData.append("bill_attachment", billAttachment);
    }

    // stringify items
    formData.append("items", JSON.stringify(items));

    fetch("/api/purchase/create/", {
      method: "POST",
        headers: {
      "X-CSRFToken": getCSRFToken(),
      "X-Requested-With": "XMLHttpRequest"
    },
    credentials: "same-origin",
    body: formData
  })
    .then(r => r.json()).then(d => {
      if (d.success) alert("Saved!");
      else alert("Error: "+d.error);
      if (d.success) window.location.reload();
    })
    .catch(e => { console.error(e); alert("Submit failed"); });
  });
});

function attachRecalcListeners(row) {
  ['.qty', '.total', '.discount', '.tax', '.taxable_price'].forEach(selector => {
    const input = row.querySelector(selector);
    if (input) {
      input.removeEventListener('input', input._recalcHandler || (()=>{}));
      input._recalcHandler = () => calculateRow(row);
      input.addEventListener('input', input._recalcHandler);
    }
  });
}

document.addEventListener('input', function (e) {
  if (e.target.classList.contains('item-name')) {
    const inputEl = e.target;
    const row = inputEl.closest('tr');
    const value = inputEl.value.trim();
    if (value.length < 2) return;

    fetch(`/ajax/get-itemname-info/?q=${encodeURIComponent(value)}`)
      .then(response => response.json())
      .then(data => {
        let list = document.createElement('ul');
        list.className = "suggestion-list";

        data.suggestions.forEach(s => {
          let li = document.createElement('li');
          li.textContent = `${s.item_name} (${s.item_code})`;
          li.addEventListener('click', () => {
            row.querySelector('.item-name').value = s.item_name;
            row.querySelector('.item-code').value = s.item_code;
            row.querySelector('.unit').value = s.unit;

            // fetch full details
            fetchItemDetails(row.querySelector('.item-name'));

            list.remove();
          });
          list.appendChild(li);
        });

        // remove old
        const oldList = inputEl.parentNode.querySelector('.suggestion-list');
        if (oldList) oldList.remove();
        inputEl.parentNode.appendChild(list);
      });
  }
});

function fetchItemDetails(inputEl) {
    const row = inputEl.closest('tr');
    const itemNameInput = row.querySelector('.item-name');
    const itemCodeInput = row.querySelector('.item-code');

    const name = itemNameInput.value.trim();
    const code = itemCodeInput.value.trim();

    const url = `/api/item/fetch/?${code ? `code=${encodeURIComponent(code)}` : `name=${encodeURIComponent(name)}`}`;

    fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          console.warn("Item not found:", data.error);
          itemNameInput.focus();
          return;
        }      

        row.querySelector('.item-name').value = data.item_name;
        row.querySelector('.item-code').value = data.code;
        row.querySelector('.hsn').value = data.hsn;       
        row.querySelector('.unit').value = data.unit;    
        row.querySelector('.price').value = data.price; 
        row.querySelector('.tax').value = data.tax;
        row.querySelector('.whole_price').value = data.wholesale;
        row.querySelector('.whole_price_2').value = data.wholesale_1;
        row.querySelector('.sale_price').value = data.sale_price;
        
        row.querySelector('.mrp').value = data.mrp;   

        const splitUnitQtyInput = row.querySelector('.unit_qty');
        const splitUnitInput = row.querySelector('.split_unit');
        const splitUnitPriceInput = row.querySelector('.split_unit_price');
        const taxableAmount = row.querySelector('.taxable_price');
        const unit = (data.unit || '').toLowerCase();

        if (unit.includes('bulk')) {
          splitUnitQtyInput.removeAttribute('readonly');
          splitUnitInput.removeAttribute('readonly');
          splitUnitPriceInput.removeAttribute('readonly');
          if (!splitUnitInput.value || splitUnitInput.value == '0' && !splitUnitPriceInput.value || splitUnitPriceInput.value == '0' && !splitUnitQtyInput.value || splitUnitQtyInput.value == '0') {
            splitUnitQtyInput.value = '';
            splitUnitInput.value = '';
            splitUnitPriceInput.value = '';
          }
          
        } else {
          splitUnitQtyInput.setAttribute('readonly', true);
          splitUnitInput.setAttribute('readonly', true);         
          splitUnitPriceInput.setAttribute('readonly', true);
          splitUnitQtyInput.value = 0;
          splitUnitInput.value = 0;
          splitUnitPriceInput.value = 0;
        }
      
        ['.qty', '.price', '.discount', '.tax', '.taxable_price'].forEach(selector => {
          const input = row.querySelector(selector);
          if (input) {
            input.addEventListener('input', () => calculateRow(row));
          }
        });

        calculateRow(row);
      })
      .catch(error => {
        console.error("Fetch item failed:", error);
      });
  }

  function getCSRFToken() {
  const cookieValue = document.cookie.split('; ')
    .find(row => row.startsWith('csrftoken='));
  return cookieValue ? cookieValue.split('=')[1] : '';
}

function calculateRow(row) {
    const qty = parseFloat(row.querySelector('.qty').value) || 0;
    const unit_qty = parseFloat(row.querySelector('.unit_qty').value) || 0;
    const amount = parseFloat(row.querySelector('.total').value) || 0;
    const discount = parseFloat(row.querySelector('.discount').value) || 0;
    const tax = parseFloat(row.querySelector('.tax').value) || 0;

    // Unit Price
    if (qty > 0) {
        const unitPrice = amount / qty;
        row.querySelector('.price').value = unitPrice.toFixed(2);
    } else {
        row.querySelector('.price').value = "0.00";
    }

    // Split Units
    const splitUnit = qty * unit_qty;
    row.querySelector('.split_unit').value = splitUnit.toFixed(2);

    // Split Unit Price
    const splitUnitPrice = splitUnit > 0 ? amount / splitUnit : 0;
    row.querySelector('.split_unit_price').value = splitUnitPrice.toFixed(2);

    // Taxable Amount
    const discountAmount = discount || 0;
    const taxableAmount = amount - discountAmount; 
    row.querySelector('.taxable_price').value = taxableAmount.toFixed(2);

    // Tax & Net Price
    const taxAmount = taxableAmount * (tax / 100);
    const netPrice = taxableAmount + taxAmount;
    row.querySelector('.net_price').value = netPrice.toFixed(2);

    // Cost Price
    const costPrice = qty > 0 ? netPrice / qty : 0;
    row.querySelector('.cost_price').value = costPrice.toFixed(2);

    updateTotals();
}

function updateTotals() {
  let subtotal = 0;
  let taxTotal = 0;
  let discountTotal = 0;

  document.querySelectorAll('#productTableBody tr').forEach(row => {
    subtotal += parseFloat(row.querySelector('.total').value) || 0;
    discountTotal += parseFloat(row.querySelector('.discount').value) || 0;
    const tax = parseFloat(row.querySelector('.tax').value) || 0;
    const discounted = (parseFloat(row.querySelector('.total').value) || 0) - discountTotal;
    taxTotal += discounted * (tax / 100); 
  });

  const total = subtotal - discountTotal + taxTotal;

  document.getElementById('subtotal').textContent = subtotal.toFixed(2);
  document.getElementById('discount').textContent = discountTotal.toFixed(2);
  document.getElementById('tax').textContent = taxTotal.toFixed(2);
  document.getElementById('total').textContent = total.toFixed(2);
}

function deleteRow(btn) {
  const row = btn.closest('tr');
  row.remove();
  updateTotals();

  // Recalculate serial numbers
  document.querySelectorAll('#productTableBody .sno').forEach((cell, i) => {
    cell.textContent = i + 1;
  });

  // Focus item name input of previous row (if exists)
  if (previousRow) {
    const input = previousRow.querySelector('.item-name');
    if (input) input.focus();
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const invoiceInput = document.getElementById("invoiceNumber");
  const productTableBody = document.getElementById("productTableBody");
  
  const amountPaidField = document.getElementById("amount-paid");
  const outstandingField = document.getElementById("outstanding_amount");
  const paymentModeField = document.getElementById("payment_mode");
  const paymentRateField = document.getElementById("payment_rate");
  const paymentRefField = document.getElementById("payment_reference");

  invoiceInput.addEventListener("change", () => {
    const invoiceNumber = invoiceInput.value.trim();
    if (!invoiceNumber) return;

    fetch(`/api/purchase/items/?invoice_number=${encodeURIComponent(invoiceNumber)}`)
      .then(r => r.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
          return;
        }
        // Clear any existing rows
        productTableBody.innerHTML = "";

        // For each item, add a row to the table
        data.items.forEach((item, i) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="sno">${i + 1}</td>
            <td><input class="form-control item-name" value="${item.item_name || ""}"></td>
            <td><input class="form-control item-code" value="${item.item_code || ""}"></td>
            <td><input class="form-control hsn" value="${item.hsn || ""}" readonly></td>
            <td><input class="form-control unit" value="${item.unit || ""}" readonly></td>
            <td><input type="number" class="form-control qty" value="${item.quantity || 1}" min="1"></td>
            <td><input type="number" class="form-control unit_qty" value="${item.unit_qty || 0}" readonly></td>
            <td><input type="number" class="form-control split_unit" value="${item.split_unit || 0}" readonly></td>
            <td><input type="number" class="form-control split_unit_price" value="${item.split_unit_price || 0}" readonly></td>
            <td><input type="number" class="form-control price" value="${item.price || 0}" step="0.01"></td>
            <td><input class="form-control total" value="${item.total_price || 0}"></td>
            <td><input type="number" class="form-control discount" value="${item.discount || 0}" step="0.01"></td>
            <td><input class="form-control taxable_price" value="${item.taxable_price || 0}"></td>
            <td><input type="number" class="form-control tax" value="${item.tax || 0}" step="0.01"></td>
            <td><input type="number" class="form-control cost_price" value="${item.cost_price || 0}" step="0.01"></td>
            <td><input type="number" class="form-control mrp" value="${item.mrp || 0}" step="0.01"></td>
            <td><input type="number" class="form-control whole_price" value="${item.whole_price || 0}" step="0.01"></td>
            <td><input type="number" class="form-control whole_price_2" value="${item.whole_price_2 || 0}" step="0.01"></td>
            <td><input type="number" class="form-control sale_price" value="${item.sale_price || 0}" step="0.01"></td>
            <td><input class="form-control net_price" value="${item.net_price || 0}" readonly></td>
            <td><input type="date" class="form-control expiry_date" value="${item.expiry_date || ""}"></td>
            <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this)">Delete</button></td>
          `;
          productTableBody.appendChild(row);
          attachRecalcListeners(row);
                    
          calculateRow(row);
        });
        updateTotals();
        
        if (data.purchase) {                           
            document.getElementById("amount-paid").value = data.purchase.amount_paid || "0.00";
            document.getElementById("outstanding-amount").textContent = data.purchase.outstanding_amount || "0.00";
            document.getElementById("payment-mode").value = data.purchase.payment_mode || "";
            document.getElementById("payment-rate").textContent = data.purchase.payment_rate || "0%";
            document.getElementById("payment-reference").value = data.purchase.payment_reference || "";
          }
      })
      .catch(e => {
        console.error("Fetch purchase items failed:", e);
        alert("Could not fetch purchase items, Invoice number duplicated for multiple purchase.");
      });
  });
});

function calculateOutstanding() {
    const total = parseFloat(document.getElementById("total").innerText) || 0;
    const amountPaidInput = document.getElementById("amount-paid");
    const currentPaidInput = document.getElementById("current-paid");

    // Parse values strictly as floats
    let previousAmountPaid = parseFloat(amountPaidInput.value) || 0;
    let currentPaid = parseFloat(currentPaidInput.value) || 0;

    if (currentPaid < 0) currentPaid = 0;

    // Prevent overpayment BEFORE summing
    if (previousAmountPaid + currentPaid > total) {
        currentPaid = total - previousAmountPaid;
        currentPaidInput.value = currentPaid.toFixed(2);
    }

    // Now calculate new total
    const newTotalPaid = previousAmountPaid + currentPaid;

    // Update amount paid
    amountPaidInput.value = newTotalPaid.toFixed(2);

    // Update outstanding
    const outstanding = total - newTotalPaid;
    document.getElementById("outstanding-amount").innerText = outstanding.toFixed(2);

    // Update payment rate
    const paymentRate = total > 0 ? (newTotalPaid / total) * 100 : 0;
    document.getElementById("payment-rate").innerText = paymentRate.toFixed(2) + "%";
}

// Update when user leaves the input (Tab or click outside)
document.getElementById("current-paid").addEventListener("blur", calculateOutstanding);

// Optional: handle Enter key as well
document.getElementById("current-paid").addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
        e.preventDefault(); // prevents form submission
    }
});

// Initial calculation on page load
calculateOutstanding();
</script>
{% endblock %}