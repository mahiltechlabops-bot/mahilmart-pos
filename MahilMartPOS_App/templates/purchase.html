{% extends "base.html" %}
{% block style %}
<style>
  #purchaseTable input {
    width: 80px;            /* compact input width */
    padding: 4px 6px;
    font-size: 13px;
    box-sizing: border-box;
  }

  #purchaseTable td,
  #purchaseTable th {
    white-space: nowrap;
    padding: 4px 6px;
    font-size: 13px;
  }

  #purchaseTable th {
    font-weight: 600;
  }

  .table-responsive {
    overflow-x: hidden;
  }

  #purchaseTable {
    width: 100%;
    table-layout: auto;
  }

  #purchaseTable td:nth-child(3) input,
  #purchaseTable td:nth-child(6) input,
  #purchaseTable td:nth-child(7) input,
  #purchaseTable td:nth-child(8) input,
  #purchaseTable td:nth-child(9) input,
  #purchaseTable td:nth-child(10) input,
  #purchaseTable td:nth-child(12) input,
  #purchaseTable td:nth-child(13) input,
  #purchaseTable td:nth-child(14) input,
  #purchaseTable td:nth-child(15) input,
  #purchaseTable td:nth-child(16) input, 
  #purchaseTable td:nth-child(17) input{
    width: 50px !important;
    padding: 3px 4px;
    font-size: 12px;
    box-sizing: border-box;
  }

  #purchaseTable td:nth-child(2) input,
  #purchaseTable td:nth-child(4) input,
  #purchaseTable td:nth-child(11) input,
  #purchaseTable td:nth-child(18) input,
  #purchaseTable td:nth-child(19) input {
    width: 90px !important;
    padding: 3px 4px;
    font-size: 12px;
    box-sizing: border-box;
  }
</style>

{% endblock %}

{% block content %}
<main class="app-content">
  <div class="card p-4 mx-auto container-fluid">
    <h3><i class="fas fa-truck-loading"></i> New Purchase</h3>

    <!-- Purchase Header -->
    <div class="row mb-4">
      <div class="col-md-6">
        <label>Select Supplier</label>
        <input list="dealerOptions" id="dealerSelect" class="form-control" placeholder="Type supplier name or phone">
        <datalist id="dealerOptions">
          {% for supplier in suppliers %}
          <option value="{{supplier.name}} ({{supplier.phone}})"
                  data-id="{{supplier.id}}"
                  data-contact="{{supplier.contact_person}}"
                  data-email="{{supplier.email}}"
                  data-address="{{supplier.address}}"
                  data-supplier="{{supplier.supplier_id}}"
                  data-account="{{supplier.account_number}}"
                  data-pan="{{supplier.pan_number}}"
                  data-bank="{{supplier.bank_name}}"
                  data-credit="{{supplier.credit_terms}}"
                  data-gst="{{supplier.gst_number}}"
                  data-ifsc="{{supplier.ifsc_code}}">
          {% endfor %}
        </datalist>
      </div>
      <div class="col-md-6">
        <label>Invoice Number</label>
        <input type="text" id="invoiceNumber" class="form-control" placeholder="Invoice No">
      </div>
    </div>

    <!-- Two-column Supplier Details -->
    <div class="row mb-3" id="supplierDetails" style="display:none;">
      <div class="col-md-12">
        <h6><b>Supplier Details:</b></h6>
        <div class="row">
          <div class="col-md-6">
            <div><b>Contact Person:</b> <span id="supplierContact"></span></div>
            <div><b>Phone:</b> <span id="supplierPhone"></span></div>
            <div><b>Email:</b> <span id="supplierEmail"></span></div>
            <div><b>Address:</b> <span id="supplierAddress"></span></div>
            <div><b>Supplier Id:</b> <span id="supplierSupplierId"></span></div>
            
          </div>
          <div class="col-md-6">
            <div><b>Bank:</b> <span id="supplierBank"></span></div>
            <div><b>Account #:</b> <span id="supplierAccount"></span></div>
            <div><b>Pan #:</b> <span id="supplierPan"></span></div>
            <div><b>IFSC:</b> <span id="supplierIFSC"></span></div>
            <div><b>GST No:</b> <span id="supplierGST"></span></div>
            <div><b>Credit Terms:</b> <span id="supplierCredit"></span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Products Table -->
    <h5>Add Products</h5>
        <div class="table-responsive" style="overflow-x: auto; max-width: 100%;">
          <table class="table table-sm table-bordered mt-3" id="purchaseTable" style="min-width: 1500px; font-size: 0.85rem;">
            <thead class="table-light">
              <tr>
                <th>S.no</th><th>Item</th><th>Code</th><th>HSN</th><th>Unit</th>
                <th>Qty</th><th>Unit Qty</th><th>Total Unit Qty</th><th>Split Cost Price</th><th>Unit Price</th><th>Amount</th><th>Discount</th><th>Tax</th><th>Cost Price</th><th>MRP</th><th>Wh</th><th>Wh 1</th>
                <th>Sale Price</th><th>Total Net</th><th>Expiry Date</th><th>Action</th>
              </tr>
            </thead>
            <tbody id="productTableBody"></tbody>
          </table>
       </div>
    <button id="addProductBtn" class="btn btn-primary">+ Add Product</button>

    <!-- Summary -->
    <div class="row mt-5">
      <div class="col-md-6">
        <h5>Purchase Summary</h5>
        <table class="table summary-table">
          <tr><td>Subtotal:</td><td>₹ <span id="subtotal">0.00</span></td></tr>
          <tr><td>Tax:</td><td>₹ <span id="tax">0.00</span></td></tr>
          <tr><td>Discount:</td><td>₹ <span id="discount">0.00</span></td></tr>
          <tr><td><strong>Total:</strong></td><td><strong>₹ <span id="total">0.00</span></strong></td></tr>
        </table>
      </div>
    </div>

    <div class="mt-4 d-flex gap-2">
      <button id="completePurchaseBtn" class="btn btn-success">Complete Purchase</button>
      <button id="cancelPurchaseBtn" class="btn btn-secondary">Cancel</button>
       <td>
          <a href="{% url 'purchase_list'%}" class="btn btn-primary btn-sm ms-auto">
          View Purchase Details
        </a>
      </td>
    </div>       
  </div>
  
</main>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const productTableBody = document.getElementById("productTableBody");
  const addProductBtn = document.getElementById("addProductBtn");
  const dealerInput = document.getElementById("dealerSelect");
  const invoiceInput = document.getElementById("invoiceNumber");
  const supplierDetails = document.getElementById("supplierDetails");

  function updateSerials() {
    productTableBody.querySelectorAll('tr').forEach((r,i)=> r.querySelector('.sno').textContent=i+1);
  }

  addProductBtn.addEventListener("click", () => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="sno"></td>
      <td><input class="form-control item-name" onblur="fetchItemDetails(this)"></td>
      <td><input class="form-control item-code" onblur="fetchItemDetails(this)"></td>
      <td><input class="form-control hsn" readonly></td>    
      <td><input class="form-control unit" readonly></td>
      <td><input type="number" class="form-control qty" value="1" min="1" oninput="calculateRow(this.closest('tr'))"></td>
      <td><input type="number" class="form-control unit_qty" value="0"" readonly></td>
      <td><input type="number" class="form-control split_unit" value="0"" readonly></td>
      <td><input type="number" class="form-control split_unit_price" value="0"" readonly></td>
      <td><input type="number" class="form-control price" value="0" step="0.01" oninput="calculateRow(this.closest('tr'))"></td>
      <td><input class="form-control total"></td>
      <td><input type="number" class="form-control discount" value="0" step="0.01" oninput="calculateRow(this.closest('tr'))"></td>
      <td><input type="number" class="form-control tax" value="0" step="0.01" oninput="calculateRow(this.closest('tr'))"></td>      
      <td><input type="number" class="form-control mrp" value="0" step="0.01"></td>
      <td><input type="number" class="form-control whole_price" value="0" step="0.01"></td>
      <td><input type="number" class="form-control whole_price_2" value="0" step="0.01"></td>
      <td><input type="number" class="form-control sale_price" value="0" step="0.01"></td>
      <td><input class="form-control net_price" readonly></td>       
      <td><input type="date" class="form-control expiry_date"></td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this)">Delete</button></td>`;
    productTableBody.appendChild(row);
    attachRecalcListeners(row);
    updateSerials();
    calculateRow(row);

    const itemInput = row.querySelector('.item-name');
    if (itemInput) itemInput.focus();
  });

  // populate supplier details
  dealerInput.addEventListener("input", () => {
    const opt = Array.from(document.getElementById("dealerOptions").options)
      .find(o => o.value === dealerInput.value);
    if (opt) {
      supplierDetails.style.display = "block";
      document.getElementById("supplierContact").textContent = opt.dataset.contact;
      document.getElementById("supplierPhone").textContent = dealerInput.value.match(/\((.+)\)/)?.[1]||"";
      document.getElementById("supplierEmail").textContent = opt.dataset.email;
      document.getElementById("supplierAddress").textContent = opt.dataset.address;
      document.getElementById("supplierSupplierId").textContent = opt.dataset.supplier;
      document.getElementById("supplierBank").textContent = opt.dataset.bank;
      document.getElementById("supplierAccount").textContent = opt.dataset.account;
      document.getElementById("supplierPan").textContent = opt.dataset.pan;
      document.getElementById("supplierIFSC").textContent = opt.dataset.ifsc;
      document.getElementById("supplierGST").textContent = opt.dataset.gst;
      document.getElementById("supplierCredit").textContent = opt.dataset.credit;
    } else {
      supplierDetails.style.display = "none";
    }
  });

  document.getElementById("cancelPurchaseBtn").addEventListener("click", () => {
    if (confirm("Clear all purchase items?")) {
      productTableBody.innerHTML = "";
      updateTotals();
    }
  });

  document.getElementById("completePurchaseBtn").addEventListener("click", () => {
    const opt = Array.from(document.getElementById("dealerOptions").options)
      .find(o => o.value === dealerInput.value);
    if (!opt || invoiceInput.value.trim()==="") {
      return alert("Please select a supplier and enter invoice number.");
    }

    const rows = document.querySelectorAll('table tbody tr');
    for (let row of rows) {
      const unit = (row.querySelector('.unit')?.textContent || '').toLowerCase();
      const splitUnitQtyInput = row.querySelector('.unit_qty');
      const splitUnitInput = row.querySelector('.split_unit');
      const splitUnitPriceInput = row.querySelector('.split_unit_price');
      
      if (unit.includes('bulk')) {
        const val = parseFloat(splitUnitInput.value);
        if (!val || val === 0) {
          alert('For BULK units, Split Unit must be greater than 0.');
          splitUnitInput.focus();
          e.preventDefault();
          return false;
        }
      }
    }

    const items = Array.from(productTableBody.querySelectorAll('tr')).map(r => ({
      item_name: r.querySelector('.item-name').value,
      item_code: r.querySelector('.item-code').value,
      hsn: r.querySelector('.hsn').value, 
      quantity: r.querySelector('.qty').value,
      unit_qty: r.querySelector('.unit_qty').value,
      split_unit: r.querySelector('.split_unit').value,
      split_unit_price: r.querySelector('.split_unit_price').value,
      price: r.querySelector('.price').value,
      total_price: r.querySelector('.total').value,
      discount: r.querySelector('.discount').value,
      tax: r.querySelector('.tax').value,
      net_price: r.querySelector('.net_price').value,
      mrp: r.querySelector('.mrp').value,
      whole_price: r.querySelector('.whole_price').value,
      whole_price_2: r.querySelector('.whole_price_2').value,
      sale_price: r.querySelector('.sale_price').value,  
      expiry_date: r.querySelector('.expiry_date').value
    }));

    fetch("/api/purchase/create/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken()
      },
      body: JSON.stringify({
        supplier_id: opt.dataset.id,
        invoice_no: invoiceInput.value.trim(),
        items
      })
    })
    .then(r => r.json()).then(d => {
      if (d.success) alert("Saved!");
      else alert("Error: "+d.error);
      if (d.success) window.location.reload();
    })
    .catch(e => { console.error(e); alert("Submit failed"); });
  });
});

function attachRecalcListeners(row) {
  ['.qty', '.price', '.discount', '.tax'].forEach(selector => {
    const input = row.querySelector(selector);
    if (input) {
      input.removeEventListener('input', input._recalcHandler || (()=>{})); // prevent duplicates
      input._recalcHandler = () => calculateRow(row);
      input.addEventListener('input', input._recalcHandler);
    }
  });
}

  function fetchItemDetails(inputEl) {
    const row = inputEl.closest('tr');
    const itemNameInput = row.querySelector('.item-name');
    const itemCodeInput = row.querySelector('.item-code');

    const name = itemNameInput.value.trim();
    const code = itemCodeInput.value.trim();

    const url = `/api/item/fetch/?${code ? `code=${encodeURIComponent(code)}` : `name=${encodeURIComponent(name)}`}`;

    fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          console.warn("Item not found:", data.error);
          return;
        }

        row.querySelector('.item-name').value = data.item_name;
        row.querySelector('.item-code').value = data.code;
        row.querySelector('.hsn').value = data.hsn;       
        row.querySelector('.unit').value = data.unit;    
        row.querySelector('.price').value = data.price; 
        row.querySelector('.tax').value = data.tax;
        row.querySelector('.whole_price').value = data.wholesale;
        row.querySelector('.whole_price_2').value = data.wholesale_1;
        row.querySelector('.sale_price').value = data.sale_price;
        row.querySelector('.mrp').value = data.mrp;   

        const splitUnitQtyInput = row.querySelector('.unit_qty');
        const splitUnitInput = row.querySelector('.split_unit');
        const splitUnitPriceInput = row.querySelector('.split_unit_price');
        const unit = (data.unit || '').toLowerCase();

        if (unit.includes('bulk')) {
          splitUnitQtyInput.removeAttribute('readonly');
          splitUnitInput.removeAttribute('readonly');
          splitUnitPriceInput.removeAttribute('readonly');
          if (!splitUnitInput.value || splitUnitInput.value == '0' && !splitUnitPriceInput.value || splitUnitPriceInput.value == '0' && !splitUnitQtyInput.value || splitUnitQtyInput.value == '0') {
            splitUnitQtyInput.value = '';
            splitUnitInput.value = '';
            splitUnitPriceInput.value = '';
          }
          
        } else {
          splitUnitQtyInput.setAttribute('readonly', true);
          splitUnitInput.setAttribute('readonly', true);         
          splitUnitPriceInput.setAttribute('readonly', true);
          splitUnitQtyInput.value = 0;
          splitUnitInput.value = 0;
          splitUnitPriceInput.value = 0;
        }

        //  Attach live recalculation for qty, price, discount, and tax
        ['.qty', '.price', '.discount', '.tax'].forEach(selector => {
          const input = row.querySelector(selector);
          if (input) {
            input.addEventListener('input', () => calculateRow(row));
          }
        });

        calculateRow(row);
      })
      .catch(error => {
        console.error("Fetch item failed:", error);
      });
  }

  function getCSRFToken() {
  const cookieValue = document.cookie.split('; ')
    .find(row => row.startsWith('csrftoken='));
  return cookieValue ? cookieValue.split('=')[1] : '';
}

function calculateRow(row) {
  const qty = parseFloat(row.querySelector('.qty').value) || 0;
  const price = parseFloat(row.querySelector('.price').value) || 0;
  const discount = parseFloat(row.querySelector('.discount').value) || 0;
  const tax = parseFloat(row.querySelector('.tax').value) || 0;

  const total = qty * price;
  const discounted = total - discount;
  const taxed = discounted + (discounted * (tax / 100));
  const net = taxed;

  row.querySelector('.total').value = total.toFixed(2);
  row.querySelector('.net_price').value = net.toFixed(2);

  updateTotals();
}

function updateTotals() {
  let subtotal = 0;
  let taxTotal = 0;
  let discountTotal = 0;

  document.querySelectorAll('#productTableBody tr').forEach(row => {
    subtotal += parseFloat(row.querySelector('.total').value) || 0;
    discountTotal += parseFloat(row.querySelector('.discount').value) || 0;
    const tax = parseFloat(row.querySelector('.tax').value) || 0;
    const discounted = (parseFloat(row.querySelector('.total').value) || 0) - discountTotal;
    taxTotal += discounted * (tax / 100);
  });

  const total = subtotal - discountTotal + taxTotal;

  document.getElementById('subtotal').textContent = subtotal.toFixed(2);
  document.getElementById('discount').textContent = discountTotal.toFixed(2);
  document.getElementById('tax').textContent = taxTotal.toFixed(2);
  document.getElementById('total').textContent = total.toFixed(2);
}

function deleteRow(btn) {
  const row = btn.closest('tr');
  row.remove();
  updateTotals();

  // Recalculate serial numbers
  document.querySelectorAll('#productTableBody .sno').forEach((cell, i) => {
    cell.textContent = i + 1;
  });

  // Focus item name input of previous row (if exists)
  if (previousRow) {
    const input = previousRow.querySelector('.item-name');
    if (input) input.focus();
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const invoiceInput = document.getElementById("invoiceNumber");
  const productTableBody = document.getElementById("productTableBody");

  invoiceInput.addEventListener("change", () => {
    const invoiceNumber = invoiceInput.value.trim();
    if (!invoiceNumber) return;

    fetch(`/api/purchase/items/?invoice_number=${encodeURIComponent(invoiceNumber)}`)
      .then(r => r.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
          return;
        }
        // Clear any existing rows
        productTableBody.innerHTML = "";

        // For each item, add a row to the table
        data.items.forEach((item, i) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="sno">${i + 1}</td>
            <td><input class="form-control item-name" value="${item.item_name || ""}"></td>
            <td><input class="form-control item-code" value="${item.item_code || ""}"></td>
            <td><input class="form-control hsn" value="${item.hsn || ""}" readonly></td>
            <td><input class="form-control unit" value="${item.unit || ""}" readonly></td>
            <td><input type="number" class="form-control qty" value="${item.quantity || 1}" min="1"></td>
            <td><input type="number" class="form-control unit_qty" value="${item.unit_qty || 0}" readonly></td>
            <td><input type="number" class="form-control split_unit" value="${item.split_unit || 0}" readonly></td>
            <td><input type="number" class="form-control split_unit_price" value="${item.split_unit_price || 0}" readonly></td>
            <td><input type="number" class="form-control price" value="${item.price || 0}" step="0.01"></td>
            <td><input class="form-control total" value="${item.total_price || 0}" readonly></td>
            <td><input type="number" class="form-control discount" value="${item.discount || 0}" step="0.01"></td>
            <td><input type="number" class="form-control tax" value="${item.tax || 0}" step="0.01"></td>
            <td><input type="number" class="form-control mrp" value="${item.mrp || 0}" step="0.01"></td>
            <td><input type="number" class="form-control whole_price" value="${item.whole_price || 0}" step="0.01"></td>
            <td><input type="number" class="form-control whole_price_2" value="${item.whole_price_2 || 0}" step="0.01"></td>
            <td><input type="number" class="form-control sale_price" value="${item.sale_price || 0}" step="0.01"></td>
            <td><input class="form-control net_price" value="${item.net_price || 0}" readonly></td>
            <td><input type="date" class="form-control expiry_date" value="${item.expiry_date || ""}"></td>
            <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this)">Delete</button></td>
          `;
          productTableBody.appendChild(row);
          attachRecalcListeners(row);
                    
          calculateRow(row);
        });
        updateTotals();
      })
      .catch(e => {
        console.error("Fetch purchase items failed:", e);
        alert("Could not fetch purchase items.");
      });
  });
});
</script>
{% endblock %}