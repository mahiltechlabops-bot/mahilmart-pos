{% extends "base.html" %}

{% block content %}
<main class="app-content">
  <div class="card p-4">
    <h3><i class="fas fa-truck-loading"></i> New Purchase</h3>

    <!-- Supplier Selection -->
    <div class="mb-4">
      <label for="dealerSelect" class="form-label">Select Supplier</label>
      <input class="form-control" list="dealerOptions" id="dealerSelect" name="supplier_name" placeholder="Type supplier name or phone">
    <datalist id="dealerOptions">
            {% for supplier in suppliers %}
                <option value="{{ supplier.name }} ({{ supplier.phone }})"
                        data-id="{{ supplier.id }}"
                        data-supplier-id="{{ supplier.supplier_id }}">
            {% endfor %}
    </datalist>
    </div>
    

    <!-- Products Table -->
    <h5>Add Products</h5>
    <table class="table table-bordered mt-3" id="purchaseTable">
      <thead class="table-light">
        <tr>
          <th>S.no</th>
          <th>Supplier ID</th>
          <th>Item Name</th>
          <th>Item Code</th>
          <th>Group</th>
          <th>Brand</th>
          <th>Unit</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Total</th>
          <th>Discount</th>
          <th>Tax</th>
          <th>Net Price</th>
          <th>MRP</th>
          <th>Wholesale</th>
          <th>Wholesale 1</th>
          <th>Sale Price</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="productTableBody">
        <!-- Dynamic rows -->
      </tbody>
    </table>

    <button type="button" class="btn btn-primary" id="addProductBtn">+ Add Product</button>

    <!-- Summary -->
    <div class="row mt-5">
      <div class="col-md-6">
        <h5>Purchase Summary</h5>
        <table class="table summary-table">
          <tr><td>Subtotal:</td><td>₹ <span id="subtotal">0.00</span></td></tr>
          <tr><td>Tax:</td><td>₹ <span id="tax">0.00</span></td></tr>
          <tr><td>Discount:</td><td>₹ <span id="discount">0.00</span></td></tr>
          <tr><td><strong>Total:</strong></td><td><strong>₹ <span id="total">0.00</span></strong></td></tr>
        </table>
      </div>
    </div>

    <div class="mt-4">
      <button class="btn btn-success" id="completePurchaseBtn">Complete Purchase</button>
      <button class="btn btn-secondary" id="cancelPurchaseBtn">Cancel</button>
    </div>
  </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const productTableBody = document.getElementById("productTableBody");
  const addProductBtn = document.getElementById("addProductBtn");

  const subtotalEl = document.getElementById("subtotal");
  const taxEl = document.getElementById("tax");
  const discountEl = document.getElementById("discount");
  const totalEl = document.getElementById("total");

  addProductBtn.addEventListener("click", () => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="sno"></td>
      <td><input type="text" class="form-control supplier-id" readonly></td>
      <td><input type="text" class="form-control item-name" onblur="fetchItemDetails(this)"></td>
      <td><input type="text" class="form-control item-code" onblur="fetchItemDetails(this)"></td>
      <td><input type="text" class="form-control group" readonly></td>
      <td><input type="text" class="form-control brand" readonly></td>
      <td><input type="text" class="form-control unit" readonly></td>
      <td><input type="number" class="form-control qty" value="1" min="1" oninput="calculateRow(this.closest('tr'))"></td>
      <td><input type="number" class="form-control price" value="0" step="0.01" oninput="calculateRow(this.closest('tr'))"></td>
      <td><input type="text" class="form-control total" readonly></td>
      <td><input type="number" class="form-control discount" value="0" step="0.01" oninput="calculateRow(this.closest('tr'))"></td>
      <td><input type="number" class="form-control tax" value="0" step="0.01" oninput="calculateRow(this.closest('tr'))"></td>
      <td><input type="text" class="form-control net_price" readonly></td>
      <td><input type="number" class="form-control mrp" value="0" step="0.01"></td>
      <td><input type="number" class="form-control whole_price" value="0" step="0.01"></td>
      <td><input type="number" class="form-control whole_price_2" value="0" step="0.01"></td>
      <td><input type="number" class="form-control sale_price" value="0" step="0.01"></td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this)">Delete</button></td>
    `;
    productTableBody.appendChild(row);
    updateSerialNumbers();
    calculateRow(row);

    const supplierInput = document.getElementById("dealerSelect").value;
    const selectedOption = Array.from(document.getElementById("dealerOptions").options)
      .find(opt => supplierInput.includes(opt.value.split(" (")[0]));
    if (selectedOption) {
      row.querySelector(".supplier-id").value = selectedOption.dataset.supplierId;
    }
  });

  document.getElementById("cancelPurchaseBtn").addEventListener("click", () => {
    if (confirm("Clear all purchase items?")) {
      productTableBody.innerHTML = "";
      subtotalEl.textContent = "0.00";
      taxEl.textContent = "0.00";
      discountEl.textContent = "0.00";
      totalEl.textContent = "0.00";
    }
  });

  function getSelectedSupplierId() {
  const input = document.getElementById("dealerSelect").value.trim();
  for (const opt of document.querySelectorAll("#dealerOptions option")) {
    if (opt.value === input) {
      return opt.dataset.id;
    }
  }
  return null;
}

  document.getElementById("completePurchaseBtn").addEventListener("click", () => {
  const supplierName = document.getElementById("dealerSelect").value;
  const supplierOption = Array.from(document.getElementById("dealerOptions").options)
    .find(opt => supplierName.includes(opt.value.split(" (")[0]));

  const supplierId = getSelectedSupplierId();
    if (!supplierId) {
        alert("Please select a supplier from the dropdown");
        return;
    }

  if (!supplierOption) {
    alert("Please select a supplier.");
    return;
  }

//   const supplierId = supplierOption.dataset.id;

  const items = Array.from(document.querySelectorAll('#productTableBody tr')).map(row => ({
    item_name: row.querySelector('.item-name').value,
    item_code: row.querySelector('.item-code').value,
    quantity: row.querySelector('.qty').value,
    price: row.querySelector('.price').value,
    total_price: row.querySelector('.total').value,
    discount: row.querySelector('.discount').value,
    tax: row.querySelector('.tax').value,
    net_price: row.querySelector('.net_price').value,
    mrp: row.querySelector('.mrp').value,
    whole_price: row.querySelector('.whole_price').value,
    whole_price_2: row.querySelector('.whole_price_2').value,
    sale_price: row.querySelector('.sale_price').value,
  }));

  fetch("/api/purchase/create/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCSRFToken()
    },
    body: JSON.stringify({
      supplier_id: supplierId,
      items: items
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert("Purchase saved successfully!");
      window.location.reload();
    } else {
      alert("Error: " + data.error);
    }
  })
  .catch(err => {
    console.error("Submit error:", err);
    alert("Failed to submit purchase.");
  });
});

function getCSRFToken() {
  return document.cookie.split('; ')
    .find(row => row.startsWith('csrftoken='))
    ?.split('=')[1];
}
});

function fetchItemDetails(input) {
  const row = input.closest("tr");
  const itemName = row.querySelector(".item-name").value.trim();
  const itemCode = row.querySelector(".item-code").value.trim();

  const url = `/api/item/fetch/?name=${encodeURIComponent(itemName)}&code=${encodeURIComponent(itemCode)}`;
  console.log("Fetching item from:", url);

  fetch(url)
    .then(res => {
      if (!res.ok) {
        throw new Error("Network response was not ok");
      }
      return res.json();
    })
    .then(data => {
      console.log(" Data received:", data);

      if (data.error) {
        alert("Item not found");
        return;
      }

      row.querySelector(".item-name").value = data.item_name || "";
      row.querySelector(".item-code").value = data.code || "";
      row.querySelector(".group").value = data.group || "";
      row.querySelector(".brand").value = data.brand || "";
      row.querySelector(".unit").value = data.unit || "";
      row.querySelector(".tax").value = data.tax || 0;
      row.querySelector(".whole_price").value = data.wholesale || 0;
      row.querySelector(".whole_price_2").value = data.wholesale_1 || 0;
      row.querySelector(".sale_price").value = data.sale_price || 0;
      row.querySelector(".mrp").value = data.mrp || 0;
      calculateRow(row);
    })
    .catch(err => {
      console.error("Fetch failed:", err);
      alert("Failed to fetch item. Check console for details.");
    });
}

function calculateRow(row) {
  const qty = parseFloat(row.querySelector('.qty').value) || 0;
  const price = parseFloat(row.querySelector('.price').value) || 0;
  const discount = parseFloat(row.querySelector('.discount').value) || 0;
  const tax = parseFloat(row.querySelector('.tax').value) || 0;

  const total = qty * price;
  const net = total - discount + (total * tax / 100);

  row.querySelector('.total').value = total.toFixed(2);
  row.querySelector('.net_price').value = net.toFixed(2);

  updateTotals();
}

function deleteRow(button) {
  button.closest("tr").remove();
  updateSerialNumbers();
  updateTotals();
}

function updateSerialNumbers() {
  document.querySelectorAll('#productTableBody tr').forEach((row, i) => {
    row.querySelector('.sno').textContent = i + 1;
  });
}

function updateTotals() {
  let subtotal = 0, tax = 0, discount = 0;

  document.querySelectorAll('#productTableBody tr').forEach(row => {
    subtotal += parseFloat(row.querySelector('.total').value) || 0;
    tax += ((parseFloat(row.querySelector('.total').value) || 0) * (parseFloat(row.querySelector('.tax').value) || 0)) / 100;
    discount += parseFloat(row.querySelector('.discount').value) || 0;
  });

  const total = subtotal + tax - discount;

  document.getElementById("subtotal").textContent = subtotal.toFixed(2);
  document.getElementById("tax").textContent = tax.toFixed(2);
  document.getElementById("discount").textContent = discount.toFixed(2);
  document.getElementById("total").textContent = total.toFixed(2);
}
</script>
{% endblock %}